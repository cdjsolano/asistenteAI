<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asistente de IA de la Empresa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .chat-container {
      width: 100%;
      max-width: 640px;
      background-color: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .message {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      word-wrap: break-word;
    }
    .message.user {
      background-color: #3b82f6;
      color: #ffffff;
      align-self: flex-end;
      border-bottom-right-radius: 0;
    }
    .message.bot {
      background-color: #f3f4f6;
      color: #1f2937;
      align-self: flex-start;
      border-bottom-left-radius: 0;
    }
    .loader {
      width: 1rem;
      height: 1rem;
      border: 2px solid #3b82f6;
      border-bottom-color: transparent;
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }
    @keyframes rotation {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body class="bg-gray-200 p-4">
  <div class="chat-container">
    <h1 class="text-2xl font-bold text-gray-800 text-center">
      Asistente de Consultas
    </h1>
    <div
      id="chat-box"
      class="flex-grow overflow-y-auto h-96 flex flex-col gap-2"
    >
      <!-- Mensajes dinámicos -->
    </div>
    <form id="chat-form" class="flex gap-2 mt-4">
      <input
        type="text"
        id="user-input"
        placeholder="Escribe tu pregunta..."
        class="flex-grow rounded-xl p-3 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <button
        type="submit"
        class="bg-blue-600 text-white rounded-xl p-3 font-semibold hover:bg-blue-700 transition-colors"
      >
        Enviar
      </button>
    </form>
  </div>

  <script>
    const API_URL = "/api/chat.js"; // backend serverless en Vercel
    let knowledgeBase = "";

    // Cargar la base de conocimientos desde archivo externo
    async function loadKnowledgeBase() {
      try {
        const res = await fetch("knowledge.txt");
        knowledgeBase = await res.text();
      } catch (err) {
        console.error("Error al cargar knowledge.txt", err);
        knowledgeBase =
          "No se pudo cargar la base de conocimientos en este momento.";
      }
    }

    // Mostrar mensajes
    function addMessage(text, sender) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${sender} shadow-sm`;
      messageDiv.textContent = text;
      chatBox.appendChild(messageDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Generar respuesta desde la API
    async function generateAnswer(question) {
      const prompt = `Actúa como un asistente de IA para una empresa. 
Responde la siguiente pregunta basándote ÚNICAMENTE en la información proporcionada. 
Si la pregunta no está relacionada, responde amablemente que esa información no es de tu competencia.

Información:
${knowledgeBase}

Pregunta del usuario: ${question}

Respuesta:`;

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
           body: JSON.stringify({
                
                message: prompt,
            }),
        });

        const data = await response.json();
        addMessage(data.reply, "bot");
      } catch (error) {
        console.error(error);
        addMessage("Error al conectar con el asistente.", "bot");
      }
    }

    // Inicialización
    const chatForm = document.getElementById("chat-form");
    const userInput = document.getElementById("user-input");
    const chatBox = document.getElementById("chat-box");

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const question = userInput.value.trim();
      if (!question) return;

      addMessage(question, "user");
      userInput.value = "";

      // loader
      const loaderDiv = document.createElement("div");
      loaderDiv.className = "message bot";
      loaderDiv.innerHTML = '<span class="loader"></span>';
      chatBox.appendChild(loaderDiv);

      await generateAnswer(question);

      loaderDiv.remove();
    });

    // cargar la base y arrancar el chat
    loadKnowledgeBase().then(() => {
      addMessage("¡Hola! Soy el asistente IA de SEM Valledupar. puedo responder preguntas sobre como hacer formal tu posesion, ya seas docente o Administrativo", "bot");
    });
  </script>
</body>
</html>
